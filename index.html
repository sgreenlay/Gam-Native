<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Gam</title>
    </head>
    <body>
        <style>
            body {
                background-color: black;
            }
            #canvas {
                position: fixed;
                width: 800px;
                left: 50%;
                margin-left: -400px;
                height: 480px;
                top: 50%;
                margin-top: -240px;
            }
        </style>
        <canvas id="canvas" width="800" height="480"></canvas>
        <script>
            var canvas = document.getElementById("canvas");
            var context = canvas.getContext("2d");

            var size = { width: canvas.width, height: canvas.height };
            var mouse = { x : 0, y : 0 };

            canvas.width = canvas.width * window.devicePixelRatio;
            canvas.height = canvas.height * window.devicePixelRatio;
            context.scale(window.devicePixelRatio, window.devicePixelRatio);

            var getRelativeCoordinates = (event) => {
                var rect = canvas.getBoundingClientRect();

                var x = event.clientX - rect.left;
                var y = event.clientY - rect.top;

                return { x : x, y : y };
            };

            canvas.addEventListener('mousemove', (event) => {
                mouse = getRelativeCoordinates(event);
            });

            var importObject = {
                env: {
                    log: arg => {
                        console.log(arg);
                    },
                    drawRect : (x, y, w, h, r, g, b, a) => {
                        context.fillStyle = 'rgba(' + r + ', ' + g + ', ' + b + ', ' + a + ')';
                        context.fillRect(x, y, w, h);
                    }
                }
            };

            WebAssembly.instantiateStreaming(fetch('main.wasm'), importObject).then(results => {
                results.instance.exports.init(size.width, size.height);

                function renderTick(timestamp) {
                    results.instance.exports.mouseMoved(mouse.x, mouse.y);
                    results.instance.exports.render();
                    window.requestAnimationFrame(renderTick);
                }
                renderTick();
            });
        </script>
    </body>
</html>